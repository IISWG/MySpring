# å‘è™šæ‹Ÿæœºæ³¨å†Œé’©å­ï¼Œå®ç°Beanå¯¹è±¡çš„åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•

## å‰è¨€

```
æœ‰ä»€ä¹ˆæ–¹å¼ï¼Œèƒ½ç»™ä»£ç ç•™æ¡æ´»è·¯ï¼Ÿ
```

<img src="image/640.png" alt="å›¾ç‰‡" style="zoom:75%;" />

æœ‰äººè¯´ï¼šäººäººéƒ½æ˜¯äº§å“ç»ç†ï¼Œé‚£ä½ çŸ¥é“å—ï¼Œäººäººä¹Ÿéƒ½å¯ä»¥æ˜¯ç å†œç¨‹åºå‘˜ï¼å°±åƒï¼š

- ç¼–ç¨‹å°±æ˜¯ï¼›å®šä¹‰å±æ€§ã€åˆ›å»ºæ–¹æ³•ã€è°ƒç”¨å±•ç¤º
- Java å’Œ PHP å°±åƒç”·äººå’Œå¥³äººï¼Œå‰è€…åœ¨ä¹æ¶æ„åŒ–æ¨¡å—åï¼Œåè€…åœ¨ä¹é‚£ä¸ªé¢œè‰²æˆ‘å–œæ¬¢
- ç”¨å¿ƒå†™ï¼Œä½†ä¸è¦ä¸åšæ ¼å¼åŒ–
- åˆæ¬¡å’Œäº§å“å¯¹æ¥çš„ä¸‰ä¸ªå®ï¼šç –å¤´ã€é“é”¹ã€èœåˆ€ï¼Œåˆ†åˆ«ä¿è¯æœ‰ç”¨ã€å¯ç”¨ã€å¥½ç”¨
- ä»ä¸€è¡Œä»£ç åˆ°ä¸€å¨ä»£ç ï¼Œå¼€å‘è¶Šæ¥è¶Šéš¾ï¼Œå£å’ä¹Ÿè¶Šæ¥è¶Šé«˜

------

å…¶å®å­¦ä¼šå†™ä»£ç å¹¶ä¸éš¾ï¼Œä½†å­¦ä¼šå†™å¥½ä»£ç å´å¾ˆéš¾ã€‚ä»æ˜“é˜…è¯»ä¸Šæ¥è¯´ä½ çš„ä»£ç è¦æœ‰å‡†ç¡®çš„å‘½åå’Œæ¸…æ™°çš„æ³¨é‡Šã€ä»æ˜“ä½¿ç”¨ä¸Šæ¥è¯´ä½ çš„ä»£ç è¦å…·å¤‡è®¾è®¡æ¨¡å¼çš„åŒ…è£…è®©å¯¹å¤–çš„æœåŠ¡è°ƒç”¨æ›´ç®€å•ã€ä»æ˜“æ‰©å±•ä¸Šæ¥è¯´ä½ çš„ä»£ç è¦åšå¥½ä¸šåŠ¡å’ŒåŠŸèƒ½çš„å®ç°åˆ†å±‚ã€‚åœ¨æ˜“é˜…è¯»ã€æ˜“ä½¿ç”¨ã€æ˜“æ‰©å±•ä»¥åŠæ›´å¤šç¼–ç è§„èŒƒçš„çº¦æŸä¸‹ï¼Œè¿˜éœ€è¦åœ¨å¼€å‘å®Œæˆä¸Šçº¿åçš„äº¤ä»˜ç»“æœä¸Šæ»¡è¶³ï¼›é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€é«˜å¹¶å‘ï¼Œä¸æ­¤åŒæ—¶ä½ è¿˜ä¼šæ¥åˆ°ç°æœ‰é¡¹ç›®ä¸­å±‚å‡ºä¸ç©·æ¥è‡ªäº§å“ç»ç†æ–°å¢çš„éœ€æ±‚ã€‚

**ğŸ™æ€ä¹ˆåŠï¼ŸçŸ¥é“ä½ åœ¨ç ç –ï¼Œä¸çŸ¥é“ä½ åœ¨ç›–å“ªä¸ªçŒªåœˆï¼**

å°±ç®—ç çš„ç –æ˜¯ç›–çš„çŒªåœˆï¼Œä¹Ÿå¾—å› ä¸ºçŒªå¤šæ‰©é¢ç§¯ã€æ”¹æ°´æ§½ã€åŠ é¥²æ–™å‘€ï¼Œæ‰€ä»¥æ ¹æœ¬æ²¡æ³•ä¿è¯ä½ å†™å®Œçš„ä»£ç å°±ä¸ä¼šåŠ éœ€æ±‚ã€‚é‚£ä¹ˆæ–°åŠ çš„éœ€æ±‚å¦‚æœæ˜¯ä»¥ç ´åäº†ä½ åŸæœ‰çš„å°è£…äº†éå¸¸å®Œç¾500è¡Œçš„ `ifelse` å’‹åŠï¼Œæ‹†äº†é‡ç›–å—ï¼Ÿ

å…„å˜šï¼Œç»™ä»£ç ç•™æ¡æ´»è·¯å§ï¼ä½ çš„ä»£ç ç”¨ä¸Šäº†å®šä¹‰æ¥å£å—ã€æ¥å£ç»§æ‰¿æ¥å£å—ã€æ¥å£ç”±æŠ½è±¡ç±»å®ç°å—ã€ç±»ç»§æ‰¿çš„ç±»å®ç°äº†æ¥å£æ–¹æ³•å—ï¼Œè€Œè¿™äº›æ“ä½œéƒ½æ˜¯ä¸ºäº†è®©ä½ çš„ç¨‹åºé€»è¾‘åšåˆ°åˆ†å±‚ã€åˆ†åŒºã€åˆ†å—ï¼ŒæŠŠæ ¸å¿ƒé€»è¾‘å±‚å’Œä¸šåŠ¡å°è£…å±‚åšå¥½éš”ç¦»ï¼Œå½“æœ‰ä¸šåŠ¡å˜åŒ–æ—¶å€™ï¼Œåªéœ€è¦åšåœ¨ä¸šåŠ¡å±‚å®Œæˆè£…é…ï¼Œè€Œåº•å±‚çš„æ ¸å¿ƒé€»è¾‘æœåŠ¡å¹¶ä¸éœ€è¦é¢‘ç¹å˜åŒ–ï¼Œå®ƒä»¬æ‰€å¢åŠ çš„æ¥å£ä¹Ÿæ›´åŸå­åŒ–ï¼Œä¸å…·å¤‡ä¸šåŠ¡è¯­æ„ã€‚æ‰€ä»¥è¿™æ ·çš„å®ç°æ–¹å¼æ‰èƒ½ç»™ä½ çš„ä»£ç ç•™æ¡æ´»è·¯ã€‚å¦‚æœè¿˜ä¸æ˜¯å¤ªç†è§£ï¼Œå¯ä»¥å¤šçœ‹çœ‹[ã€Šé‡å­¦Javaè®¾è®¡æ¨¡å¼ã€‹](http://mp.weixin.qq.com/s?__biz=MzIxMDAwMDAxMw==&mid=2650730482&idx=1&sn=11aed73fedac04f2366bef99c0fa7722&chksm=8f610e10b8168706070bad8176de68dc9b963e45f12dbf9d2cad61e7924be028c95315bd42c4&scene=21#wechat_redirect)å’Œç°åœ¨ç¼–å†™çš„[ã€Šæ‰‹æ’¸Springã€‹](http://mp.weixin.qq.com/s?__biz=MzIxMDAwMDAxMw==&mid=2650730541&idx=1&sn=9fcd5baf6ec3e880786c4a0384166bdd&chksm=8f6111cfb81698d9bb5a4c61075d87658f7296bdb42ea72dd1b7d4312f3b75f719399ed2223c&scene=21#wechat_redirect)ï¼Œè¿™é‡Œé¢éƒ½æœ‰å¤§é‡çš„è®¾è®¡æ¨¡å¼åº”ç”¨å®è·µ

## **ç›®æ ‡**

å½“æˆ‘ä»¬çš„ç±»åˆ›å»ºçš„ Bean å¯¹è±¡ï¼Œäº¤ç»™ Spring å®¹å™¨ç®¡ç†ä»¥åï¼Œè¿™ä¸ªç±»å¯¹è±¡å°±å¯ä»¥è¢«èµ‹äºˆæ›´å¤šçš„ä½¿ç”¨èƒ½åŠ›ã€‚å°±åƒæˆ‘ä»¬åœ¨ä¸Šä¸€ç« èŠ‚å·²ç»ç»™ç±»å¯¹è±¡æ·»åŠ äº†ä¿®æ”¹æ³¨å†ŒBeanå®šä¹‰æœªå®ä¾‹åŒ–å‰çš„å±æ€§ä¿¡æ¯ä¿®æ”¹å’Œå®ä¾‹åŒ–è¿‡ç¨‹ä¸­çš„å‰ç½®å’Œåç½®å¤„ç†ï¼Œè¿™äº›é¢å¤–èƒ½åŠ›çš„å®ç°ï¼Œéƒ½å¯ä»¥è®©æˆ‘ä»¬å¯¹ç°æœ‰å·¥ç¨‹ä¸­çš„ç±»å¯¹è±¡åšç›¸åº”çš„æ‰©å±•å¤„ç†ã€‚

é‚£ä¹ˆé™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¸Œæœ›å¯ä»¥åœ¨ Bean åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæ‰§è¡Œä¸€äº›æ“ä½œã€‚æ¯”å¦‚å¸®æˆ‘ä»¬åšä¸€äº›æ•°æ®çš„åŠ è½½æ‰§è¡Œï¼Œé“¾æ¥æ³¨å†Œä¸­å¿ƒæš´æ¼RPCæ¥å£ä»¥åŠåœ¨Webç¨‹åºå…³é—­æ—¶æ‰§è¡Œé“¾æ¥æ–­å¼€ï¼Œå†…å­˜é”€æ¯ç­‰æ“ä½œã€‚*å¦‚æœè¯´æ²¡æœ‰Springæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ã€é™æ€æ–¹æ³•ä»¥åŠæ‰‹åŠ¨è°ƒç”¨çš„æ–¹å¼å®ç°ï¼Œä½†è¿™æ ·çš„å¤„ç†æ–¹å¼ç»ˆç©¶ä¸å¦‚æŠŠè¯¸å¦‚æ­¤ç±»çš„æ“ä½œéƒ½äº¤ç»™ Spring å®¹å™¨æ¥ç®¡ç†æ›´åŠ åˆé€‚ã€‚* å› æ­¤ä½ ä¼šçœ‹åˆ°åˆ° spring.xml ä¸­æœ‰å¦‚ä¸‹æ“ä½œï¼š

<img src="image/640-16556057493353.png" alt="å›¾ç‰‡" style="zoom:80%;" />

- éœ€è¦æ»¡è¶³ç”¨æˆ·å¯ä»¥åœ¨ xml ä¸­é…ç½®åˆå§‹åŒ–å’Œé”€æ¯çš„æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å®ç°ç±»çš„æ–¹å¼å¤„ç†ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ä½¿ç”¨ Spring æ—¶ç”¨åˆ°çš„ InitializingBean, DisposableBean ä¸¤ä¸ªæ¥å£ã€‚-å…¶å®è¿˜å¯ä»¥æœ‰ä¸€ç§æ˜¯æ³¨è§£çš„æ–¹å¼å¤„ç†åˆå§‹åŒ–æ“ä½œï¼Œä¸è¿‡ç›®å‰è¿˜æ²¡æœ‰å®ç°åˆ°æ³¨è§£çš„é€»è¾‘ï¼Œåç»­å†å®Œå–„æ­¤ç±»åŠŸèƒ½ã€‚



## **è®¾è®¡** 

å¯èƒ½é¢å¯¹åƒ Spring è¿™æ ·åºå¤§çš„æ¡†æ¶ï¼Œå¯¹å¤–æš´éœ²çš„æ¥å£å®šä¹‰ä½¿ç”¨æˆ–è€…xmlé…ç½®ï¼Œå®Œæˆçš„ä¸€ç³»åˆ—æ‰©å±•æ€§æ“ä½œï¼Œéƒ½è®© Spring æ¡†æ¶çœ‹ä¸Šå»å¾ˆç¥ç§˜ã€‚å…¶å®å¯¹äºè¿™æ ·åœ¨ Bean å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­é¢å¤–æ·»åŠ çš„å¤„ç†æ“ä½œï¼Œæ— éå°±æ˜¯é¢„å…ˆæ‰§è¡Œäº†ä¸€ä¸ªå®šä¹‰å¥½çš„æ¥å£æ–¹æ³•æˆ–è€…æ˜¯åå°„è°ƒç”¨ç±»ä¸­xmlä¸­é…ç½®çš„æ–¹æ³•ï¼Œæœ€ç»ˆä½ åªè¦æŒ‰ç…§æ¥å£å®šä¹‰å®ç°ï¼Œå°±ä¼šæœ‰ Spring å®¹å™¨åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­è¿›è¡Œè°ƒç”¨è€Œå·²ã€‚æ•´ä½“è®¾è®¡ç»“æ„å¦‚ä¸‹å›¾ï¼š

<img src="image/640-16556059249295.png" alt="å›¾ç‰‡" style="zoom:75%;" />

- åœ¨ spring.xml é…ç½®ä¸­æ·»åŠ  `init-methodã€destroy-method` ä¸¤ä¸ªæ³¨è§£ï¼Œåœ¨é…ç½®æ–‡ä»¶åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼ŒæŠŠæ³¨è§£é…ç½®ä¸€å¹¶å®šä¹‰åˆ° BeanDefinition çš„å±æ€§å½“ä¸­ã€‚è¿™æ ·åœ¨ initializeBean åˆå§‹åŒ–æ“ä½œçš„å·¥ç¨‹ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡åå°„çš„æ–¹å¼æ¥è°ƒç”¨é…ç½®åœ¨ Bean å®šä¹‰å±æ€§å½“ä¸­çš„æ–¹æ³•ä¿¡æ¯äº†ã€‚å¦å¤–å¦‚æœæ˜¯æ¥å£å®ç°çš„æ–¹å¼ï¼Œé‚£ä¹ˆç›´æ¥å¯ä»¥é€šè¿‡ Bean å¯¹è±¡è°ƒç”¨å¯¹åº”æ¥å£å®šä¹‰çš„æ–¹æ³•å³å¯ï¼Œ`((InitializingBean) bean).afterPropertiesSet()`ï¼Œä¸¤ç§æ–¹å¼è¾¾åˆ°çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚
- é™¤äº†åœ¨åˆå§‹åŒ–åšçš„æ“ä½œå¤–ï¼Œ`destroy-method` å’Œ `DisposableBean` æ¥å£çš„å®šä¹‰ï¼Œéƒ½ä¼šåœ¨ Bean å¯¹è±¡åˆå§‹åŒ–å®Œæˆé˜¶æ®µï¼Œæ‰§è¡Œæ³¨å†Œé”€æ¯æ–¹æ³•çš„ä¿¡æ¯åˆ° DefaultSingletonBeanRegistry ç±»ä¸­çš„ disposableBeans å±æ€§é‡Œï¼Œè¿™æ˜¯ä¸ºäº†åç»­ç»Ÿä¸€è¿›è¡Œæ“ä½œã€‚*è¿™é‡Œè¿˜æœ‰ä¸€æ®µé€‚é…å™¨çš„ä½¿ç”¨ï¼Œå› ä¸ºåå°„è°ƒç”¨å’Œæ¥å£ç›´æ¥è°ƒç”¨ï¼Œæ˜¯ä¸¤ç§æ–¹å¼ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨é€‚é…å™¨è¿›è¡ŒåŒ…è£…ï¼Œä¸‹æ–‡ä»£ç è®²è§£ä¸­å‚è€ƒ DisposableBeanAdapter çš„å…·ä½“å®ç°*-å…³äºé”€æ¯æ–¹æ³•éœ€è¦åœ¨è™šæ‹Ÿæœºæ‰§è¡Œå…³é—­ä¹‹å‰è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°ä¸€ä¸ªæ³¨å†Œé’©å­çš„æ“ä½œï¼Œå¦‚ï¼š`Runtime.getRuntime().addShutdownHook(new Thread(() -> System.out.println("closeï¼")));` *è¿™æ®µä»£ç ä½ å¯ä»¥æ‰§è¡Œæµ‹è¯•*ï¼Œå¦å¤–ä½ å¯ä»¥ä½¿ç”¨æ‰‹åŠ¨è°ƒç”¨ ApplicationContext.close æ–¹æ³•å…³é—­å®¹å™¨ã€‚

## **å®ç°**

Spring åº”ç”¨ä¸Šä¸‹æ–‡å’Œå¯¹Beanå¯¹è±¡æ‰©å±•æœºåˆ¶çš„ç±»å…³ç³»

<img src="image/640-16556270763697.png" alt="å›¾ç‰‡" style="zoom:67%;" />

- ä»¥ä¸Šæ•´ä¸ªç±»å›¾ç»“æ„æè¿°å‡ºæ¥çš„å°±æ˜¯æœ¬æ¬¡æ–°å¢ Bean å®ä¾‹åŒ–è¿‡ç¨‹ä¸­çš„åˆå§‹åŒ–æ–¹æ³•å’Œé”€æ¯æ–¹æ³•ã€‚
- å› ä¸ºæˆ‘ä»¬ä¸€å…±å®ç°äº†ä¸¤ç§æ–¹å¼çš„åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•ï¼Œxmlé…ç½®å’Œå®šä¹‰æ¥å£ï¼Œæ‰€ä»¥è¿™é‡Œæ—¢æœ‰ InitializingBeanã€DisposableBean ä¹Ÿæœ‰éœ€è¦ XmlBeanDefinitionReader åŠ è½½ spring.xml é…ç½®ä¿¡æ¯åˆ° BeanDefinition ä¸­ã€‚
- å¦å¤–æ¥å£ ConfigurableBeanFactory å®šä¹‰äº† destroySingletons é”€æ¯æ–¹æ³•ï¼Œå¹¶ç”± AbstractBeanFactory ç»§æ‰¿çš„çˆ¶ç±» DefaultSingletonBeanRegistry å®ç° ConfigurableBeanFactory æ¥å£å®šä¹‰çš„ destroySingletons æ–¹æ³•ã€‚*è¿™ç§æ–¹å¼çš„è®¾è®¡å¯èƒ½æ•°ç¨‹åºå‘˜æ˜¯æ²¡æœ‰ç”¨è¿‡çš„ï¼Œéƒ½æ˜¯ç”¨çš„è°å®ç°æ¥å£è°å®Œæˆå®ç°ç±»ï¼Œè€Œä¸æ˜¯æŠŠå®ç°æ¥å£çš„æ“ä½œåˆäº¤ç»™ç»§æ‰¿çš„çˆ¶ç±»å¤„ç†ã€‚æ‰€ä»¥è¿™å—è¿˜æ˜¯è›®æœ‰æ„æ€çš„ï¼Œæ˜¯ä¸€ç§ä¸é”™çš„éš”ç¦»åˆ†å±‚æœåŠ¡çš„è®¾è®¡æ–¹å¼*
- æœ€åå°±æ˜¯å…³äºå‘è™šæ‹Ÿæœºæ³¨å†Œé’©å­ï¼Œä¿è¯åœ¨è™šæ‹Ÿæœºå…³é—­ä¹‹å‰ï¼Œæ‰§è¡Œé”€æ¯æ“ä½œã€‚`Runtime.getRuntime().addShutdownHook(new Thread(() -> System.out.println("closeï¼")));`

### 1.å®šä¹‰åˆå§‹åŒ–å’Œé”€æ¯æ–¹æ³•çš„æ¥å£

**cn.muxin.springframework.beans.factory.InitializingBean**

```java
public interface InitializingBean {

    /**
     * Bean å¤„ç†äº†å±æ€§å¡«å……åè°ƒç”¨
     * 
     * @throws Exception
     */
    void afterPropertiesSet() throws Exception;

}
```

**cn.muxin.springframework.beans.factory.DisposableBean**

```java
public interface DisposableBean {

    void destroy() throws Exception;

}
```

- InitializingBeanã€DisposableBeanï¼Œä¸¤ä¸ªæ¥å£æ–¹æ³•è¿˜æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ï¼Œåœ¨ä¸€äº›éœ€è¦ç»“åˆ Spring å®ç°çš„ç»„ä»¶ä¸­ï¼Œç»å¸¸ä¼šä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•æ¥åšä¸€äº›å‚æ•°çš„åˆå§‹åŒ–å’Œé”€æ¯æ“ä½œã€‚æ¯”å¦‚æ¥å£æš´æ¼ã€æ•°æ®åº“æ•°æ®è¯»å–ã€é…ç½®æ–‡ä»¶åŠ è½½ç­‰ç­‰ã€‚

### 2.  Beanå±æ€§å®šä¹‰æ–°å¢åˆå§‹åŒ–å’Œé”€æ¯

**cn.muxin.springframework.beans.factory.config.BeanDefinition**

```java
public class BeanDefinition {

    private Class beanClass;

    private PropertyValues propertyValues;

    private String initMethodName;
    
    private String destroyMethodName;
    
    // ...get/set
}
```

- åœ¨ BeanDefinition æ–°å¢åŠ äº†ä¸¤ä¸ªå±æ€§ï¼šinitMethodNameã€destroyMethodNameï¼Œè¿™ä¸¤ä¸ªå±æ€§æ˜¯ä¸ºäº†åœ¨ spring.xml é…ç½®çš„ Bean å¯¹è±¡ä¸­ï¼Œå¯ä»¥é…ç½® `init-method="initDataMethod" destroy-method="destroyDataMethod"` æ“ä½œï¼Œæœ€ç»ˆå®ç°æ¥å£çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚*åªä¸è¿‡ä¸€ä¸ªæ˜¯æ¥å£æ–¹æ³•çš„ç›´æ¥è°ƒç”¨ï¼Œå¦å¤–æ˜¯ä¸€ä¸ªåœ¨é…ç½®æ–‡ä»¶ä¸­è¯»å–åˆ°æ–¹æ³•åå°„è°ƒç”¨*

### 3.æ‰§è¡Œ Bean å¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•

**cn.muxin.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory**

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory {

    private InstantiationStrategy instantiationStrategy = new CglibSubclassingInstantiationStrategy();

    @Override
    protected Object createBean(String beanName, BeanDefinition beanDefinition, Object[] args) throws BeansException {
        Object bean = null;
        try {
            bean = createBeanInstance(beanDefinition, beanName, args);
            // ç»™ Bean å¡«å……å±æ€§
            applyPropertyValues(beanName, bean, beanDefinition);
            // æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•
            bean = initializeBean(beanName, bean, beanDefinition);
        } catch (Exception e) {
            throw new BeansException("Instantiation of bean failed", e);
        }

        // ...

        addSingleton(beanName, bean);
        return bean;
    }

    private Object initializeBean(String beanName, Object bean, BeanDefinition beanDefinition) {
        // 1. æ‰§è¡Œ BeanPostProcessor Before å¤„ç†
        Object wrappedBean = applyBeanPostProcessorsBeforeInitialization(bean, beanName);

        // æ‰§è¡Œ Bean å¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•
        try {
            invokeInitMethods(beanName, wrappedBean, beanDefinition);
        } catch (Exception e) {
            throw new BeansException("Invocation of init method of bean[" + beanName + "] failed", e);
        }

        // 2. æ‰§è¡Œ BeanPostProcessor After å¤„ç†
        wrappedBean = applyBeanPostProcessorsAfterInitialization(bean, beanName);
        return wrappedBean;
    }

    private void invokeInitMethods(String beanName, Object bean, BeanDefinition beanDefinition) throws Exception {
        // 1. å®ç°æ¥å£ InitializingBean
        if (bean instanceof InitializingBean) {
            ((InitializingBean) bean).afterPropertiesSet();
        }

        // 2. é…ç½®ä¿¡æ¯ init-method {åˆ¤æ–­æ˜¯ä¸ºäº†é¿å…äºŒæ¬¡æ‰§è¡Œé”€æ¯}
        String initMethodName = beanDefinition.getInitMethodName();
        if (StrUtil.isNotEmpty(initMethodName)) {
            Method initMethod = beanDefinition.getBeanClass().getMethod(initMethodName);
            if (null == initMethod) {
                throw new BeansException("Could not find an init method named '" + initMethodName + "' on bean with name '" + beanName + "'");
            }
            initMethod.invoke(bean);
        }
    }

}
```

- æŠ½è±¡ç±» AbstractAutowireCapableBeanFactory ä¸­çš„ createBean æ˜¯ç”¨æ¥åˆ›å»º Bean å¯¹è±¡çš„æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æˆ‘ä»¬ä¹‹å‰å·²ç»æ‰©å±•äº† BeanFactoryPostProcessorã€BeanPostProcessor æ“ä½œï¼Œè¿™é‡Œæˆ‘ä»¬ç»§ç»­å®Œå–„æ‰§è¡Œ Bean å¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•çš„å¤„ç†åŠ¨ä½œã€‚
- åœ¨æ–¹æ³• invokeInitMethods ä¸­ï¼Œä¸»è¦åˆ†ä¸ºä¸¤å—æ¥æ‰§è¡Œå®ç°äº† InitializingBean æ¥å£çš„æ“ä½œï¼Œå¤„ç† afterPropertiesSet æ–¹æ³•ã€‚å¦å¤–ä¸€ä¸ªæ˜¯åˆ¤æ–­é…ç½®ä¿¡æ¯ init-method æ˜¯å¦å­˜åœ¨ï¼Œæ‰§è¡Œåå°„è°ƒç”¨ initMethod.invoke(bean)ã€‚è¿™ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥åœ¨ Bean å¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¿›è¡Œå¤„ç†åŠ è½½ Bean å¯¹è±¡ä¸­çš„åˆå§‹åŒ–æ“ä½œï¼Œè®©ä½¿ç”¨è€…å¯ä»¥é¢å¤–æ–°å¢åŠ è‡ªå·±æƒ³è¦çš„åŠ¨ä½œã€‚

###  4.å®šä¹‰é”€æ¯æ–¹æ³•é€‚é…å™¨(æ¥å£å’Œé…ç½®)

**cn.muxin.springframework.beans.factory.support.DisposableBeanAdapter**

```java
public class DisposableBeanAdapter implements DisposableBean {

    private final Object bean;
    private final String beanName;
    private String destroyMethodName;

    public DisposableBeanAdapter(Object bean, String beanName, BeanDefinition beanDefinition) {
        this.bean = bean;
        this.beanName = beanName;
        this.destroyMethodName = beanDefinition.getDestroyMethodName();
    }

    @Override
    public void destroy() throws Exception {
        // 1. å®ç°æ¥å£ DisposableBean
        if (bean instanceof DisposableBean) {
            ((DisposableBean) bean).destroy();
        }

        // 2. é…ç½®ä¿¡æ¯ destroy-method {åˆ¤æ–­æ˜¯ä¸ºäº†é¿å…äºŒæ¬¡æ‰§è¡Œé”€æ¯}
        if (StrUtil.isNotEmpty(destroyMethodName) && !(bean instanceof DisposableBean && "destroy".equals(this.destroyMethodName))) {
            Method destroyMethod = bean.getClass().getMethod(destroyMethodName);
            if (null == destroyMethod) {
                throw new BeansException("Couldn't find a destroy method named '" + destroyMethodName + "' on bean with name '" + beanName + "'");
            }
            destroyMethod.invoke(bean);
        }
        
    }

}
```

- å¯èƒ½ä½ ä¼šæƒ³è¿™é‡Œæ€ä¹ˆæœ‰ä¸€ä¸ªé€‚é…å™¨çš„ç±»å‘¢ï¼Œå› ä¸ºé”€æ¯æ–¹æ³•æœ‰ä¸¤ç§ç”šè‡³å¤šç§æ–¹å¼ï¼Œç›®å‰æœ‰`å®ç°æ¥å£ DisposableBean`ã€`é…ç½®ä¿¡æ¯ destroy-method`ï¼Œä¸¤ç§æ–¹å¼ã€‚è€Œè¿™ä¸¤ç§æ–¹å¼çš„é”€æ¯åŠ¨ä½œæ˜¯ç”± AbstractApplicationContext åœ¨æ³¨å†Œè™šæ‹Ÿæœºé’©å­åçœ‹ï¼Œè™šæ‹Ÿæœºå…³é—­å‰æ‰§è¡Œçš„æ“ä½œåŠ¨ä½œã€‚
- é‚£ä¹ˆåœ¨é”€æ¯æ‰§è¡Œæ—¶ä¸å¤ªå¸Œæœ›è¿˜å¾—å…³æ³¨éƒ½é”€æ¯é‚£äº›ç±»å‹çš„æ–¹æ³•ï¼Œå®ƒçš„ä½¿ç”¨ä¸Šæ›´å¸Œæœ›æ˜¯æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£è¿›è¡Œé”€æ¯ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ–°å¢äº†é€‚é…ç±»ï¼Œåšç»Ÿä¸€å¤„ç†ã€‚

### 5.åˆ›å»ºBeanæ—¶æ³¨å†Œé”€æ¯æ–¹æ³•å¯¹è±¡

**cn.muxin.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory**

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory implements AutowireCapableBeanFactory {

    private InstantiationStrategy instantiationStrategy = new CglibSubclassingInstantiationStrategy();

    @Override
    protected Object createBean(String beanName, BeanDefinition beanDefinition, Object[] args) throws BeansException {
        Object bean = null;
        try {
            bean = createBeanInstance(beanDefinition, beanName, args);
            // ç»™ Bean å¡«å……å±æ€§
            applyPropertyValues(beanName, bean, beanDefinition);
            // æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•
            bean = initializeBean(beanName, bean, beanDefinition);
        } catch (Exception e) {
            throw new BeansException("Instantiation of bean failed", e);
        }

        // æ³¨å†Œå®ç°äº† DisposableBean æ¥å£çš„ Bean å¯¹è±¡
        registerDisposableBeanIfNecessary(beanName, bean, beanDefinition);

        addSingleton(beanName, bean);
        return bean;
    }

    protected void registerDisposableBeanIfNecessary(String beanName, Object bean, BeanDefinition beanDefinition) {
        if (bean instanceof DisposableBean || StrUtil.isNotEmpty(beanDefinition.getDestroyMethodName())) {
            registerDisposableBean(beanName, new DisposableBeanAdapter(bean, beanName, beanDefinition));
        }
    }

}
```

- åœ¨åˆ›å»º Bean å¯¹è±¡çš„å®ä¾‹çš„æ—¶å€™ï¼Œéœ€è¦æŠŠé”€æ¯æ–¹æ³•ä¿å­˜èµ·æ¥ï¼Œæ–¹ä¾¿åç»­æ‰§è¡Œé”€æ¯åŠ¨ä½œè¿›è¡Œè°ƒç”¨ã€‚
- é‚£ä¹ˆè¿™ä¸ªé”€æ¯æ–¹æ³•çš„å…·ä½“æ–¹æ³•ä¿¡æ¯ï¼Œä¼šè¢«æ³¨å†Œåˆ° DefaultSingletonBeanRegistry ä¸­æ–°å¢åŠ çš„ `Map<String, DisposableBean> disposableBeans` å±æ€§ä¸­å»ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£çš„æ–¹æ³•æœ€ç»ˆå¯ä»¥è¢«ç±» AbstractApplicationContext çš„ close æ–¹æ³•é€šè¿‡ `getBeanFactory().destroySingletons()` è°ƒç”¨ã€‚
- åœ¨æ³¨å†Œé”€æ¯æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ ¹æ®æ˜¯æ¥å£ç±»å‹å’Œé…ç½®ç±»å‹ç»Ÿä¸€äº¤ç»™ DisposableBeanAdapter é”€æ¯é€‚é…å™¨ç±»æ¥åšç»Ÿä¸€å¤„ç†ã€‚*å®ç°äº†æŸä¸ªæ¥å£çš„ç±»å¯ä»¥è¢« instanceof åˆ¤æ–­æˆ–è€…å¼ºè½¬åè°ƒç”¨æ¥å£æ–¹æ³•*

### 6.è™šæ‹Ÿæœºå…³é—­é’©å­æ³¨å†Œè°ƒç”¨é”€æ¯æ–¹æ³•

**cn.muxin.springframework.context.ConfigurableApplicationContext**

```java
public interface ConfigurableApplicationContext extends ApplicationContext {

    void refresh() throws BeansException;

    void registerShutdownHook();

    void close();

}
```

- é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ ConfigurableApplicationContext æ¥å£ä¸­å®šä¹‰æ³¨å†Œè™šæ‹Ÿæœºé’©å­çš„æ–¹æ³• `registerShutdownHook` å’Œæ‰‹åŠ¨æ‰§è¡Œå…³é—­çš„æ–¹æ³• `close`ã€‚

**cn.muxin.springframework.context.support.AbstractApplicationContext**

```java
public abstract class AbstractApplicationContext extends DefaultResourceLoader implements ConfigurableApplicationContext {

    // ...

    @Override
    public void registerShutdownHook() {
        Runtime.getRuntime().addShutdownHook(new Thread(this::close));
    }

    @Override
    public void close() {
        getBeanFactory().destroySingletons();
    }

}
```

- è¿™é‡Œä¸»è¦ä½“ç°äº†å…³äºæ³¨å†Œé’©å­å’Œå…³é—­çš„æ–¹æ³•å®ç°ï¼Œä¸Šæ–‡æåˆ°è¿‡çš„ `Runtime.getRuntime().addShutdownHook`ï¼Œå¯ä»¥å°è¯•éªŒè¯ã€‚åœ¨ä¸€äº›ä¸­é—´ä»¶å’Œç›‘æ§ç³»ç»Ÿçš„è®¾è®¡ä¸­ä¹Ÿå¯ä»¥ç”¨å¾—åˆ°ï¼Œæ¯”å¦‚ç›‘æµ‹æœåŠ¡å™¨å®•æœºï¼Œæ‰§è¡Œå¤‡æœºå¯åŠ¨æ“ä½œã€‚

## **æ€»ç»“**

- æœ¬æ–‡ä¸»è¦å®Œæˆäº†å…³äºåˆå§‹å’Œé”€æ¯åœ¨ä½¿ç”¨æ¥å£å®šä¹‰ `implements InitializingBean, DisposableBean` å’Œåœ¨spring.xmlä¸­é…ç½® `init-method="initDataMethod" destroy-method="destroyDataMethod"` çš„ä¸¤ç§å…·ä½“åœ¨ `AbstractAutowireCapableBeanFactory` å®Œæˆåˆå§‹æ–¹æ³•å’Œ `AbstractApplicationContext` å¤„ç†é”€æ¯åŠ¨ä½œçš„å…·ä½“å®ç°è¿‡ç¨‹ã€‚
- é€šè¿‡æœ¬æ–‡çš„å®ç°å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ°ç›®å‰è¿™ä¸ª Spring æ¡†æ¶å¯¹ Bean çš„æ“ä½œè¶Šæ¥è¶Šå®Œå–„äº†ï¼Œå¯æ‰©å±•æ€§ä¹Ÿä¸æ–­çš„å¢å¼ºã€‚ä½ æ—¢å¯ä»¥åœ¨Beanæ³¨å†Œå®Œæˆå®ä¾‹åŒ–å‰è¿›è¡Œ BeanFactoryPostProcessor æ“ä½œï¼Œä¹Ÿå¯ä»¥åœ¨Beanå®ä¾‹åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œå‰ç½®å’Œåç½®æ“ä½œï¼Œç°åœ¨åˆå¯ä»¥æ‰§è¡ŒBeançš„åˆå§‹åŒ–æ–¹æ³•å’Œé”€æ¯æ–¹æ³•ã€‚æ‰€ä»¥ä¸€ä¸ªç®€å•çš„Beanå¯¹è±¡ï¼Œå·²ç»è¢«èµ‹äºˆäº†å„ç§æ‰©å±•èƒ½åŠ›ã€‚
- åœ¨å­¦ä¹ å’ŒåŠ¨æ‰‹å®è·µ Spring æ¡†æ¶å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯å®ƒå¯¹æ¥å£å’ŒæŠ½è±¡ç±»çš„æŠŠæ¡å’Œä½¿ç”¨ï¼Œå°¤å…¶é‡åˆ°ç±»ä¼¼ï¼ŒAç»§æ‰¿Bå®ç°Cæ—¶ï¼ŒCçš„æ¥å£æ–¹æ³•ç”±Aç»§æ‰¿çš„çˆ¶ç±»Bå®ç°ï¼Œè¿™æ ·çš„æ“ä½œéƒ½è›®æœ‰æ„æ€çš„ã€‚ä¹Ÿæ˜¯å¯ä»¥å¤ç”¨åˆ°é€šå¸¸çš„ä¸šåŠ¡ç³»ç»Ÿå¼€å‘ä¸­è¿›è¡Œå¤„ç†ä¸€äº›å¤æ‚é€»è¾‘çš„åŠŸèƒ½åˆ†å±‚ï¼Œåšåˆ°ç¨‹åºçš„å¯æ‰©å±•ã€æ˜“ç»´æŠ¤ç­‰ç‰¹æ€§ã€‚
